module.exports = function(app) {  var fs = require('fs')  , formidable = require('formidable')  , Vehicle = app.models.vehicle  ;  var VehicleController = {    index: function(req, res) {      Vehicle.find({}, function(err, vehicles) {        res.json(vehicles);      });    },    create: function(req, res) {      var form = new formidable.IncomingForm();      form.encoding = 'utf-8';      form.uploadDir = process.env.HOME;      form.parse(req, function(parseErr, fields, files) {        var filePath = files.file.path        , vehicle = {          picture: {            filename: files.file.name,            contentType: files.file.type          },          name: fields.name,          driver: fields.driver,          capacity: fields.capacity        };        // FIXME use createWriteStream instead        fs.writeFile(filePath, function() {          var newPath = process.env.HOME + '/' + files.file.name;          fs.rename(filePath, newPath, function() {            Vehicle.create(vehicle, function(err, doc) {              if (err) return res.json(500, err);              res.json(201, doc);            });          });        });      });    },    show: function(req, res) {      var id = req.params.id;      Vehicle.findById(id, function(err, vehicle) {        if (err) return res.json(500, err);        res.json(vehicle);      });    },    image: function(req, res) {      var file = req.params.file      , img = fs.readFile(process.env.HOME + '/' + file, function(err) {        res.writeHead(200, { 'Content-Type': 'image/png' });      	res.end(img, 'binary');      });    }  };  return VehicleController;};